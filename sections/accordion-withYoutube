{{ 'shopdev-product-details-accordion.css' | asset_url | stylesheet_tag }}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web/src/regular/style.css" />

<style>
  .shopdev-product-details-accordion .accordion-item {
    border-bottom: 1px solid #e5e7eb;
  }

  .shopdev-product-details-accordion .accordion-button {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: all 0.3s ease;
  }

  .shopdev-product-details-accordion .accordion-button:hover {
    opacity: 0.7;
  }

  .shopdev-product-details-accordion .accordion-icon {
    transition: transform 0.3s ease;
    font-size: 20px;
    flex-shrink: 0;
  }

  .shopdev-product-details-accordion .accordion-button.active .accordion-icon {
    transform: rotate(180deg);
  }

  .shopdev-product-details-accordion .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .shopdev-product-details-accordion .accordion-content.active {
    max-height: 5000px; /* 動画が増えるため高さをさらに余裕持たせました */
    padding-bottom: 20px;
  }

  .shopdev-product-details-accordion .accordion-title {
    font-size: 16px;
    font-weight: 700;
    margin: 0;
    padding-right: 16px;
  }

  .shopdev-product-details-accordion .notice-box {
    background-color: #fef3c7;
    border: 2px solid #f59e0b;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .shopdev-product-details-accordion .notice-box-title {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 12px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .shopdev-product-details-accordion .notice-box-icon {
    font-size: 20px;
    flex-shrink: 0;
  }

  .shopdev-product-details-accordion .notice-box-content {
    font-size: 14px;
    line-height: 1.6;
  }

  @media (max-width: 768px) {
    .shopdev-product-details-accordion .notice-box {
      padding: 16px;
    }

    .shopdev-product-details-accordion .notice-box-title {
      font-size: 15px;
    }

    .shopdev-product-details-accordion .notice-box-content {
      font-size: 13px;
    }
  }

  .shopdev-product-details-accordion .accordion-text {
    font-size: 14px;
    line-height: 1.6;
    color: #6b7280;
  }
  
  .shopdev-product-details-accordion .accordion-text img {
    max-width: 100%;
    height: auto;
  }

  /* --- 動画用の追加スタイル --- */
  .shopdev-product-details-accordion .accordion-video-wrapper {
    margin-top: 16px;
    width: 100%;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    position: relative;
    background: #000;
  }
  
  /* YouTube用: アスペクト比を維持 */
  .shopdev-product-details-accordion .youtube-wrapper {
    aspect-ratio: 16 / 9;
  }
  
  .shopdev-product-details-accordion .youtube-wrapper iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  .shopdev-product-details-accordion video {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
  }

  /* PC/SP 切り替えロジック */
  @media (max-width: 768px) {
    .shopdev-product-details-accordion .accordion-button {
      padding: 16px 0;
    }

    .shopdev-product-details-accordion .accordion-title {
      font-size: 15px;
    }

    .shopdev-product-details-accordion .accordion-text {
      font-size: 13px;
    }

    .shopdev-hidden-on-mobile {
      display: none !important;
    }
    .shopdev-hidden-on-desktop {
      display: block !important;
    }
  }

  @media (min-width: 769px) {
    .shopdev-hidden-on-desktop {
      display: none !important;
    }
    .shopdev-hidden-on-mobile {
      display: block !important;
    }
  }
</style>

<div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  {% if section.settings.section_title != blank %}
    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-center" style="color: {{ section.settings.title_color }}">
      {{ section.settings.section_title }}
    </h2>
  {% endif %}

  <div class="accordion-container">
    {% for block in section.blocks %}
      {% if block.type == 'notice_box' %}
        {% if block.settings.title != blank %}
          <div class="notice-box" {{ block.shopify_attributes }} style="background-color: {{ block.settings.background_color }}; 
border-color: {{ block.settings.border_color }};">
            <h3 class="notice-box-title" style="color: {{ block.settings.title_color }}">
              <i class="ph ph-warning-circle notice-box-icon" style="color: {{ block.settings.title_color }}"></i>
              {{ block.settings.title }}
            </h3>
            {% if block.settings.content != blank %}
              <div class="notice-box-content" style="color: {{ block.settings.text_color }}">
                {{ block.settings.content }}
              </div>
            {% endif %}
          </div>
        {% endif %}
      {% elsif block.type == 'accordion_item' %}
        {% if block.settings.title != blank %}
          <div class="accordion-item" {{ block.shopify_attributes }}>
            <button 
              class="accordion-button {% if block.settings.open_by_default %}active{% endif %}" 
              type="button"
              aria-expanded="{% if block.settings.open_by_default %}true{% else %}false{% endif %}"
              data-accordion-button
            >
              <h3 class="accordion-title" style="color: {{ section.settings.text_color }}">
                {{ block.settings.title }}
              </h3>
              <i class="ph ph-caret-down accordion-icon" style="color: {{ section.settings.icon_color }}"></i>
            </button>
            
            <div class="accordion-content {% if block.settings.open_by_default %}active{% endif %}" data-accordion-content>
              
              {% comment %} テキストコンテンツ / 商品説明 {% endcomment %}
              <div class="accordion-text" style="color: {{ section.settings.content_color }}">
                {% if block.settings.use_product_description %}
                  {{ product.description }}
                {% else %}
                  {% if block.settings.content != blank %}
                    {{ block.settings.content }}
                  {% endif %}
                {% endif %}
              </div>

              {% comment %} --- ファイルアップロード動画 (PC/SP出し分け) --- {% endcomment %}
              
              {% assign video_autoplay = block.settings.video_autoplay %}
              {% assign video_controls = true %}
              {% if video_autoplay %}
                {% assign video_controls = false %}
              {% endif %}

              {% comment %} PC用動画 {% endcomment %}
              {% if block.settings.video_pc != blank %}
                <div class="accordion-video-wrapper {% if block.settings.video_mobile != blank %}shopdev-hidden-on-mobile{% endif %}">
                  {{ block.settings.video_pc | video_tag: image_size: '1200x', loop: video_autoplay, autoplay: video_autoplay, muted: video_autoplay, controls: video_controls, playsinline: true }}
                </div>
              {% endif %}

              {% comment %} スマホ用動画 {% endcomment %}
              {% if block.settings.video_mobile != blank %}
                <div class="accordion-video-wrapper shopdev-hidden-on-desktop">
                  {{ block.settings.video_mobile | video_tag: image_size: '600x', loop: video_autoplay, autoplay: video_autoplay, muted: video_autoplay, controls: video_controls, playsinline: true }}
                </div>
              {% endif %}

              {% comment %} --- YouTube動画 (複数掲載可能) --- {% endcomment %}
              
              {% if block.settings.youtube_video_1 != blank %}
                <div class="accordion-video-wrapper youtube-wrapper">
                  {% if block.settings.youtube_video_1.type == 'youtube' %}
                    <iframe src="https://www.youtube.com/embed/{{ block.settings.youtube_video_1.id }}?playsinline=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                  {% elsif block.settings.youtube_video_1.type == 'vimeo' %}
                    <iframe src="https://player.vimeo.com/video/{{ block.settings.youtube_video_1.id }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                  {% endif %}
                </div>
              {% endif %}

              {% if block.settings.youtube_video_2 != blank %}
                <div class="accordion-video-wrapper youtube-wrapper">
                  {% if block.settings.youtube_video_2.type == 'youtube' %}
                    <iframe src="https://www.youtube.com/embed/{{ block.settings.youtube_video_2.id }}?playsinline=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                  {% elsif block.settings.youtube_video_2.type == 'vimeo' %}
                    <iframe src="https://player.vimeo.com/video/{{ block.settings.youtube_video_2.id }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                  {% endif %}
                </div>
              {% endif %}

              {% if block.settings.youtube_video_3 != blank %}
                <div class="accordion-video-wrapper youtube-wrapper">
                  {% if block.settings.youtube_video_3.type == 'youtube' %}
                    <iframe src="https://www.youtube.com/embed/{{ block.settings.youtube_video_3.id }}?playsinline=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                  {% elsif block.settings.youtube_video_3.type == 'vimeo' %}
                    <iframe src="https://player.vimeo.com/video/{{ block.settings.youtube_video_3.id }}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                  {% endif %}
                </div>
              {% endif %}
              
            </div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</div>

<script>
  class ProductAccordion {
    constructor(container) {
      this.container = container;
      this.buttons = container.querySelectorAll('[data-accordion-button]');
      this.init();
    }

    init() {
      this.buttons.forEach(button => {
        button.addEventListener('click', (e) => this.toggleAccordion(e.currentTarget));
      });
    }

    toggleAccordion(button) {
      const content = button.nextElementSibling;
      const isActive = button.classList.contains('active');
      // Close all accordions if single_open is enabled
      {% if section.settings.single_open %}
      this.buttons.forEach(btn => {
        if (btn !== button) {
          btn.classList.remove('active');
          btn.setAttribute('aria-expanded', 'false');
          btn.nextElementSibling.classList.remove('active');
          // 閉じた時に動画を停止
          const videos = btn.nextElementSibling.querySelectorAll('video, iframe');
          videos.forEach(v => {
            if(v.tagName === 'VIDEO') v.pause();
            // iframe(YouTube)の停止は複雑なため、srcをリセットする簡易リセット
            if(v.tagName === 'IFRAME') {
               const src = v.src;
               v.src = src; 
            }
          });
        }
      });
      {% endif %}

      // Toggle current accordion
      if (isActive) {
        button.classList.remove('active');
        button.setAttribute('aria-expanded', 'false');
        content.classList.remove('active');
      } else {
        button.classList.add('active');
        button.setAttribute('aria-expanded', 'true');
        content.classList.add('active');
        
        // ファイルアップロード動画の自動再生
        const videos = content.querySelectorAll('video[autoplay]');
        videos.forEach(v => v.play().catch(e => console.log('Autoplay prevented')));
      }
    }
  }

  // Initialize accordion
  document.addEventListener('DOMContentLoaded', () => {
    const accordionContainers = document.querySelectorAll('.accordion-container');
    accordionContainers.forEach(container => {
      new ProductAccordion(container);
    });
  });
  // Reinitialize on Shopify section events
  if (Shopify && Shopify.designMode) {
    document.addEventListener('shopify:section:load', (event) => {
      const container = event.target.querySelector('.accordion-container');
      if (container) {
        new ProductAccordion(container);
      }
    });
  }
</script>

{% schema %}
{
  "name": "Product Details Accordion",
  "class": "shopdev shopdev-product-details-accordion",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "セクションタイトル"
    },
    {
      "type": "checkbox",
      "id": "single_open",
      "label": "一度に1つのみ開く",
      "default": true,
      "info": "有効にすると、1つのアコーディオンを開くと他のアコーディオンが自動的に閉じます"
    },
    {
      "type": "header",
      "content": "カラー設定"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "セクションタイトルの色",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "アコーディオンタイトルの色",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "content_color",
      "label": "コンテンツテキストの色",
      "default": "#6b7280"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "アイコンの色",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "accordion_item",
      "name": "アコーディオン項目",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "タイトル",
          "default": "商品詳細"
        },
        {
          "type": "checkbox",
          "id": "use_product_description",
          "label": "商品詳細説明を自動で読み込む",
          "default": false,
          "info": "有効にすると、下のコンテンツ入力欄は無視され、商品管理画面の「説明」がここに表示されます。"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "テキストコンテンツ",
          "default": "<p>こちらに商品の詳細情報を入力してください。</p>"
        },
        {
          "type": "header",
          "content": "ファイルアップロード動画設定"
        },
        {
          "type": "paragraph",
          "content": "Shopifyにアップロードした動画を使用する場合 (PC/スマホ出し分け可)"
        },
        {
          "type": "video",
          "id": "video_pc",
          "label": "動画 (PC用/共通)",
          "info": "スマホ用動画が未設定の場合、こちらがスマホでも表示されます。"
        },
        {
          "type": "video",
          "id": "video_mobile",
          "label": "動画 (スマホ用)",
          "info": "設定すると、スマホ（幅768px以下）ではこちらの動画が表示されます。"
        },
        {
          "type": "checkbox",
          "id": "video_autoplay",
          "label": "自動再生・ループ・ミュートを有効にする",
          "default": true
        },
        {
          "type": "header",
          "content": "YouTube/Vimeo設定"
        },
        {
          "type": "paragraph",
          "content": "YouTubeやVimeoのURLを入力してください（最大3つ）。"
        },
        {
          "type": "video_url",
          "id": "youtube_video_1",
          "label": "YouTube動画 1",
          "accept": ["youtube", "vimeo"]
        },
        {
          "type": "video_url",
          "id": "youtube_video_2",
          "label": "YouTube動画 2",
          "accept": ["youtube", "vimeo"]
        },
        {
          "type": "video_url",
          "id": "youtube_video_3",
          "label": "YouTube動画 3",
          "accept": ["youtube", "vimeo"]
        },
        {
          "type": "checkbox",
          "id": "open_by_default",
          "label": "デフォルトで開く",
          "default": false
        }
      ]
    },
    {
      "type": "notice_box",
      "name": "注意事項ボックス",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "タイトル",
          "default": "事前にご確認ください"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "コンテンツ",
          "default": "<p>重要な注意事項をこちらに記載してください。</p>"
        },
        {
          "type": "header",
          "content": "カラー設定"
        },
        {
          "type": "color",
          "id": "background_color",
          "label": "背景色",
          "default": "#fef3c7"
        },
        {
          "type": "color",
          "id": "border_color",
          "label": "枠線の色",
          "default": "#f59e0b"
        },
        {
          "type": "color",
          "id": "title_color",
          "label": "タイトルの色",
          "default": "#92400e"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "テキストの色",
          "default": "#78350f"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Details Accordion",
      "settings": {
        "section_title": "商品について",
        "single_open": true,
        "title_color": "#000000",
        "text_color": "#000000",
        "content_color": "#6b7280",
        "icon_color": "#000000"
      },
      "blocks": [
        {
          "type": "notice_box",
          "settings": {
            "title": "事前にご確認ください",
            "content": "<p>・お取り寄せ商品は、ご注文後2〜3週間でのお届けとなります。<br>・商品の色味は、お使いのモニターにより実際の色と異なる場合がございます。<br>・返品・交換は未使用・タグ付きの状態で商品到着後7日以内に限ります。</p>",
            "background_color": "#fef3c7",
            "border_color": "#f59e0b",
            "title_color": "#92400e",
            "text_color": "#78350f"
          }
        },
        {
          "type": "accordion_item",
          "settings": {
            "title": "商品説明",
            "use_product_description": true,
            "open_by_default": true
          }
        },
        {
          "type": "accordion_item",
          "settings": {
            "title": "着用方法・スタイリング（動画あり）",
            "content": "<p>動画で着用方法をご確認いただけます。</p>",
            "open_by_default": false
          }
        },
        {
          "type": "accordion_item",
          "settings": {
            "title": "素材・お手入れ方法",
            "content": "<p><strong>素材:</strong> ポリエステル95%、スパンデックス5%<br><strong>お手入れ:</strong> 手洗いまたは洗濯機の弱水流で洗濯可能。低温でアイロンをかけてください。漂白剤の使用は避けてください。</p>",
            "open_by_default": false
          }
        }
      ]
    }
  ]
}
{% endschema %}
